---
title: "`r params$prj_cd` Data Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill

params:
  src_db: "Data/Processed/IA21_700_FNprocessed_16Sep21.accdb"
  plotallspc: FALSE
  spc1: "334"
  spc2: "081"
  spc3: "091"
  
---

```{r setup_Access, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(gfsR) # due to plyr namespace conflicts gfsR needs to be loaded before dplyr
library(httr)
library(jsonlite)
library(dplyr)
library(RODBC)

fetch_data <- function(table, src_db){
  DBConnection <- odbcConnectAccess2007(src_db, uid = "", pwd = "")
  dat <- sqlFetch(DBConnection, table, as.is=TRUE, stringsAsFactors=FALSE)
  odbcClose(DBConnection)
  return(dat)
}

fn011 <- fetch_data("011", params$src_db)
fn121 <- fetch_data("121", params$src_db)
fn123 <- fetch_data("123", params$src_db)
fn123 <- append.spc.names(fn123)
fn125 <- fetch_data("125", params$prj_cd, src_db)

prj_ldr <- paste(fn011$PRJ_LDR.FIRST_NAME, 
                 fn011$PRJ_LDR.LAST_NAME, sep =" ")

spc_sum <- fn123 |> group_by(SPC) |> 
  summarize(N = sum(CATCNT)) 
spc_sum <-  append.spc.names(spc_sum)
spc_sum <- arrange(spc_sum, desc(N))
```

Fish Data
=====================

```{r}
library(plotly)
if(params$plotallspc) {fn125 <- filter(fn125, SPC %in% c(params$spc1, params$spc2, params$spc3))}
fig <- plot_ly(data = fn125, x = ~FLEN, y = ~RWT, color = ~SPC)
fig

```

